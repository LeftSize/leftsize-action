# LeftSize Action Repository

## Purpose
A GitHub Action that analyzes repository size changes in pull requests. It provides detailed insights about file additions, deletions, and overall repository growth to help maintain lean codebases.

## Technology Stack
- **Language**: TypeScript
- **Runtime**: Node.js
- **Framework**: GitHub Actions toolkit (@actions/core, @actions/github)
- **Build**: ncc (compile to single file)

## Project Structure
```
leftsize-action/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.ts           # Entry point, orchestrates the action
‚îÇ   ‚îú‚îÄ‚îÄ analyzer.ts       # Size analysis logic
‚îÇ   ‚îî‚îÄ‚îÄ reporter.ts       # PR comment generation
‚îú‚îÄ‚îÄ dist/
‚îÇ   ‚îî‚îÄ‚îÄ index.js          # Compiled action (checked into git)
‚îú‚îÄ‚îÄ action.yml            # Action metadata and inputs/outputs
‚îî‚îÄ‚îÄ .github/workflows/
    ‚îî‚îÄ‚îÄ test.yml          # CI: Test the action
```

## How It Works

1. **Triggered on Pull Request**: Action runs when PR is opened/updated
2. **Clone & Compare**: Compares target branch vs PR branch
3. **Analyze Changes**: Calculates file sizes, additions, deletions
4. **Report**: Posts or updates comment on PR with size analysis

## Action Inputs

```yaml
inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true
  
  size-limit:
    description: 'Maximum allowed size increase in bytes'
    required: false
    default: '1048576'  # 1 MB
  
  fail-on-exceed:
    description: 'Fail the action if size limit is exceeded'
    required: false
    default: 'false'
```

## Action Outputs

```yaml
outputs:
  size-change:
    description: 'Net size change in bytes'
  
  exceeds-limit:
    description: 'Whether size change exceeds configured limit'
```

## Usage Example

In a repository's `.github/workflows/leftsize.yml`:

```yaml
name: Check Repository Size
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  size-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison
      
      - uses: LeftSize/leftsize-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          size-limit: 1048576  # 1 MB
          fail-on-exceed: true
```

## Development

### Setup
```bash
npm install
```

### Build
```bash
npm run build
# Compiles TypeScript and bundles to dist/index.js
```

### Local Testing
```bash
npm test
```

### Testing in GitHub
1. Push changes to a branch
2. Create a PR in a test repository using your branch:
   ```yaml
   - uses: YourUsername/leftsize-action@your-branch
   ```

## Deployment

### Publishing a New Version
1. **Make changes** to src/
2. **Build**: `npm run build`
3. **Commit dist/**: Git commit includes compiled dist/index.js
4. **Tag release**: 
   ```bash
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```
5. **Create GitHub Release**: Publish release on GitHub
6. **Update major tag** (e.g., v1):
   ```bash
   git tag -fa v1 -m "Update v1 tag"
   git push origin v1 --force
   ```

### Why dist/ is Checked In
- GitHub Actions cannot install dependencies at runtime
- Action must be distributed as a single compiled file
- Users reference the action, GitHub downloads from the ref

## Analysis Features

### What It Measures
- **Total repository size**: Before and after
- **Files added**: New files in PR
- **Files deleted**: Removed files
- **Files modified**: Changed files with size delta
- **Net change**: Total size difference

### Report Format
The action posts a comment on the PR:

```markdown
## üìä Repository Size Analysis

| Metric | Value |
|--------|-------|
| Size before | 1.2 MB |
| Size after | 1.5 MB |
| **Change** | **+300 KB** ‚ö†Ô∏è |

### Files Changed
- ‚úÖ `src/feature.ts`: +50 KB
- ‚ùå `old-code.ts`: -10 KB
- üìù `readme.md`: +2 KB

‚ö†Ô∏è This PR exceeds the size limit of 1 MB
```

## Backend Integration

### Future: API Reporting
The action will eventually send data to the LeftSize backend API:

```typescript
// POST https://api.leftsize.com/workflow-runs
{
  installation_id: 86933161,
  repository: "owner/repo",
  pull_number: 123,
  size_before: 1200000,
  size_after: 1500000,
  files_changed: [...]
}
```

### Authentication
- GitHub App installation token
- Passed via `github-token` input
- Backend validates token and installation access

## Common Issues

### "dist/index.js is out of date"
- Forgot to run `npm run build` before committing
- **Fix**: Build and commit dist/

### "Action not found"
- Tag doesn't exist or not pushed
- **Fix**: Ensure tag is pushed to GitHub

### "Permission denied" when posting comment
- Insufficient token permissions
- **Fix**: Ensure `github-token` has `pull-requests: write` permission

### Large dist/index.js file
- Bundled dependencies are large
- **Fix**: Review dependencies, exclude unnecessary packages

## CI/CD

### Test Workflow
`.github/workflows/test.yml` runs on every push:
- Installs dependencies
- Runs TypeScript compiler
- Executes unit tests
- Verifies dist/ is up to date

## Related Repositories
- **leftsize**: Backend API for data storage and reporting
- **website**: Marketing website with onboarding flow
- **infra**: Azure infrastructure for backend

## Roadmap
- [ ] Send analysis data to backend API
- [ ] Support custom size limit configurations per directory
- [ ] Visualize size trends over time
- [ ] Detect large files (e.g., accidental binary commits)
- [ ] Integration with GitHub Checks API (not just comments)
